name: Update data

on:
  # Manual trigger from the GitHub UI
  workflow_dispatch:

  # Scheduled run (every day at 10:00 UTC â€” tweak as you like)
  schedule:
    - cron: "0 10 * * *"

jobs:
  build-and-update:
    runs-on: ubuntu-latest

    # Needed so the workflow can push commits
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.4.1"

      - name: Install R packages
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          # These are the ones your script uses; add/remove as needed
          extra-packages: |
            any::dplyr
            any::readr
            any::stringr
            any::purrr
            any::janitor
            any::tidyr
            any::ggplot2
            any::forcats
            any::tibble
            any::lubridate
          needs: script

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run data pipeline (Torvik + Hoop + R)
        run: |
          bash scripts/download_torvik_2026.sh
          python3 scripts/request.py
          Rscript scripts/build_data.R

      - name: Commit and push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected, committing..."
            git add .
            git commit -m "Auto-update data $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          else
            echo "No changes to commit."
          fi
